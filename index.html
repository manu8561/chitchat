<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Imageboard</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Lucide icons as inline SVG components
    const Hash = ({ size = 24, ...props }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
        <line x1="4" y1="9" x2="20" y2="9"></line>
        <line x1="4" y1="15" x2="20" y2="15"></line>
        <line x1="10" y1="3" x2="8" y2="21"></line>
        <line x1="16" y1="3" x2="14" y2="21"></line>
      </svg>
    );

    const Lock = ({ size = 24, ...props }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
      </svg>
    );

    const Plus = ({ size = 24, ...props }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const Send = ({ size = 24, ...props }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    );

    const Copy = ({ size = 24, ...props }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    );

    const Check = ({ size = 24, ...props }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    );

    // Simple localStorage-based storage for standalone HTML
    const storage = {
      get: (key) => {
        return new Promise((resolve) => {
          const value = localStorage.getItem(key);
          resolve(value ? { key, value, shared: false } : null);
        });
      },
      set: (key, value) => {
        return new Promise((resolve) => {
          localStorage.setItem(key, value);
          resolve({ key, value, shared: false });
        });
      },
      delete: (key) => {
        return new Promise((resolve) => {
          localStorage.removeItem(key);
          resolve({ key, deleted: true, shared: false });
        });
      },
      list: (prefix) => {
        return new Promise((resolve) => {
          const keys = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (!prefix || key.startsWith(prefix)) {
              keys.push(key);
            }
          }
          resolve({ keys, prefix, shared: false });
        });
      }
    };

    function Imageboard() {
      const [channels, setChannels] = useState([]);
      const [currentChannel, setCurrentChannel] = useState(null);
      const [threads, setThreads] = useState([]);
      const [newThreadContent, setNewThreadContent] = useState('');
      const [newThreadSubject, setNewThreadSubject] = useState('');
      const [replyContent, setReplyContent] = useState({});
      const [showNewChannel, setShowNewChannel] = useState(false);
      const [newChannelName, setNewChannelName] = useState('');
      const [newChannelPrivate, setNewChannelPrivate] = useState(false);
      const [joinCode, setJoinCode] = useState('');
      const [showJoinModal, setShowJoinModal] = useState(false);
      const [copiedCode, setCopiedCode] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        loadData();
      }, []);

      useEffect(() => {
        if (currentChannel) {
          loadThreads();
        }
      }, [currentChannel]);

      const loadData = async () => {
        try {
          const channelsResult = await storage.list('channel:');
          if (channelsResult && channelsResult.keys && channelsResult.keys.length > 0) {
            const channelData = await Promise.all(
              channelsResult.keys.map(async (key) => {
                try {
                  const result = await storage.get(key);
                  return result ? JSON.parse(result.value) : null;
                } catch {
                  return null;
                }
              })
            );
            const validChannels = channelData.filter(c => c !== null);
            setChannels(validChannels);
            if (validChannels.length > 0 && !currentChannel) {
              setCurrentChannel(validChannels[0]);
            }
          } else {
            const defaultChannel = {
              id: 'general',
              name: 'general',
              isPrivate: false,
              createdAt: Date.now()
            };
            await storage.set(`channel:${defaultChannel.id}`, JSON.stringify(defaultChannel));
            setChannels([defaultChannel]);
            setCurrentChannel(defaultChannel);
          }
        } catch (error) {
          console.log('No channels found, starting fresh');
          const defaultChannel = {
            id: 'general',
            name: 'general',
            isPrivate: false,
            createdAt: Date.now()
          };
          await storage.set(`channel:${defaultChannel.id}`, JSON.stringify(defaultChannel));
          setChannels([defaultChannel]);
          setCurrentChannel(defaultChannel);
        }
        setLoading(false);
      };

      const loadThreads = async () => {
        if (!currentChannel) return;
        try {
          const threadsResult = await storage.list(`thread:${currentChannel.id}:`);
          if (threadsResult && threadsResult.keys) {
            const threadData = await Promise.all(
              threadsResult.keys.map(async (key) => {
                try {
                  const result = await storage.get(key);
                  return result ? JSON.parse(result.value) : null;
                } catch {
                  return null;
                }
              })
            );
            const validThreads = threadData.filter(t => t !== null).sort((a, b) => b.lastBump - a.lastBump);
            setThreads(validThreads);
          } else {
            setThreads([]);
          }
        } catch (error) {
          setThreads([]);
        }
      };

      const generateCode = () => {
        return Math.random().toString(36).substring(2, 10).toUpperCase();
      };

      const createChannel = async () => {
        if (!newChannelName.trim()) return;
        
        const channelId = newChannelName.toLowerCase().replace(/[^a-z0-9]/g, '-');
        const code = newChannelPrivate ? generateCode() : null;
        
        const channel = {
          id: channelId,
          name: newChannelName,
          isPrivate: newChannelPrivate,
          code: code,
          createdAt: Date.now()
        };

        await storage.set(`channel:${channelId}`, JSON.stringify(channel));
        setChannels([...channels, channel]);
        setCurrentChannel(channel);
        setNewChannelName('');
        setNewChannelPrivate(false);
        setShowNewChannel(false);
        
        if (code) {
          setCopiedCode(code);
          setTimeout(() => setCopiedCode(null), 5000);
        }
      };

      const joinChannel = async () => {
        if (!joinCode.trim()) return;
        
        try {
          const channelsResult = await storage.list('channel:');
          if (channelsResult && channelsResult.keys) {
            for (const key of channelsResult.keys) {
              try {
                const result = await storage.get(key);
                if (result) {
                  const channel = JSON.parse(result.value);
                  if (channel.code === joinCode.toUpperCase()) {
                    if (!channels.find(c => c.id === channel.id)) {
                      setChannels([...channels, channel]);
                    }
                    setCurrentChannel(channel);
                    setJoinCode('');
                    setShowJoinModal(false);
                    return;
                  }
                }
              } catch {}
            }
          }
          alert('Invalid code');
        } catch (error) {
          alert('Error joining channel');
        }
      };

      const createThread = async () => {
        if (!newThreadContent.trim() || !currentChannel) return;

        const threadId = `${currentChannel.id}-${Date.now()}`;
        const thread = {
          id: threadId,
          channelId: currentChannel.id,
          subject: newThreadSubject.trim() || 'No Subject',
          content: newThreadContent,
          replies: [],
          createdAt: Date.now(),
          lastBump: Date.now(),
          replyCount: 0
        };

        await storage.set(`thread:${currentChannel.id}:${threadId}`, JSON.stringify(thread));
        setThreads([thread, ...threads]);
        setNewThreadContent('');
        setNewThreadSubject('');
      };

      const addReply = async (threadId) => {
        const content = replyContent[threadId];
        if (!content || !content.trim()) return;

        const threadKey = `thread:${currentChannel.id}:${threadId}`;
        try {
          const result = await storage.get(threadKey);
          if (result) {
            const thread = JSON.parse(result.value);
            const reply = {
              id: Date.now(),
              content: content,
              timestamp: Date.now()
            };
            thread.replies.push(reply);
            thread.lastBump = Date.now();
            thread.replyCount = thread.replies.length;
            
            await storage.set(threadKey, JSON.stringify(thread));
            
            setThreads(threads.map(t => t.id === threadId ? thread : t).sort((a, b) => b.lastBump - a.lastBump));
            setReplyContent({ ...replyContent, [threadId]: '' });
          }
        } catch (error) {
          console.error('Error adding reply:', error);
        }
      };

      const copyCode = (code) => {
        navigator.clipboard.writeText(code);
        setCopiedCode(code);
        setTimeout(() => setCopiedCode(null), 2000);
      };

      const formatTime = (timestamp) => {
        const date = new Date(timestamp);
        return date.toLocaleString('en-US', { 
          month: '2-digit', 
          day: '2-digit', 
          year: '2-digit',
          hour: '2-digit', 
          minute: '2-digit',
          hour12: false
        });
      };

      if (loading) {
        return (
          <div className="min-h-screen bg-indigo-50 flex items-center justify-center font-mono">
            Loading...
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-indigo-50 font-mono text-slate-900">
          {/* Header */}
          <div className="bg-violet-600 p-4 border-b-4 border-slate-900" style={{boxShadow: '0 4px 0 rgb(91,33,182)'}}>
            <h1 className="text-3xl font-bold text-amber-100 tracking-wider m-0" style={{textShadow: '2px 2px 0 rgb(15,23,42)'}}>
              â–“â–’â–‘ IMAGEBOARD â–‘â–’â–“
            </h1>
          </div>

          <div className="flex" style={{minHeight: 'calc(100vh - 70px)'}}>
            {/* Sidebar */}
            <div className="w-[280px] bg-violet-200 border-r-4 border-slate-900 p-5 overflow-y-auto">
              <div className="mb-5">
                <button
                  onClick={() => setShowNewChannel(!showNewChannel)}
                  className="w-full p-3 bg-slate-900 text-amber-100 border-slate-900 cursor-pointer text-sm font-mono font-bold mb-2 hover:translate-y-0.5 transition-transform"
                  style={{border: '3px solid rgb(15,23,42)', boxShadow: '3px 3px 0 rgb(124,58,237)'}}
                >
                  <Plus size={16} className="inline mr-2 align-middle" />
                  NEW CHANNEL
                </button>
                <button
                  onClick={() => setShowJoinModal(true)}
                  className="w-full p-3 bg-white text-slate-900 border-slate-900 cursor-pointer text-sm font-mono font-bold hover:translate-y-0.5 transition-transform"
                  style={{border: '3px solid rgb(15,23,42)', boxShadow: '3px 3px 0 rgb(124,58,237)'}}
                >
                  <Lock size={16} className="inline mr-2 align-middle" />
                  JOIN PRIVATE
                </button>
              </div>

              {showNewChannel && (
                <div className="bg-white border-slate-900 p-4 mb-5" style={{border: '3px solid rgb(15,23,42)', boxShadow: '3px 3px 0 rgb(124,58,237)'}}>
                  <input
                    type="text"
                    placeholder="Channel name"
                    value={newChannelName}
                    onChange={(e) => setNewChannelName(e.target.value)}
                    className="w-full p-2.5 border-2 border-slate-900 mb-2.5 font-mono text-sm"
                  />
                  <label className="flex items-center mb-3 text-sm">
                    <input
                      type="checkbox"
                      checked={newChannelPrivate}
                      onChange={(e) => setNewChannelPrivate(e.target.checked)}
                      className="mr-2"
                    />
                    Private (requires code)
                  </label>
                  <button
                    onClick={createChannel}
                    className="w-full p-2.5 bg-violet-600 text-amber-100 border-2 border-slate-900 cursor-pointer font-mono font-bold text-sm hover:bg-violet-700 transition-colors"
                  >
                    CREATE
                  </button>
                </div>
              )}

              <div className="text-xs font-bold mb-3 text-violet-800">
                CHANNELS:
              </div>
              {channels.map(channel => (
                <div
                  key={channel.id}
                  onClick={() => setCurrentChannel(channel)}
                  className={`p-3 mb-2 border-2 border-slate-900 cursor-pointer text-sm font-bold hover:translate-y-0.5 transition-transform ${
                    currentChannel?.id === channel.id ? 'bg-violet-600 text-amber-100' : 'bg-white text-slate-900'
                  }`}
                  style={{boxShadow: '2px 2px 0 rgb(124,58,237)'}}
                >
                  {channel.isPrivate ? <Lock size={14} className="inline mr-2 align-middle" /> : <Hash size={14} className="inline mr-2 align-middle" />}
                  {channel.name}
                  {channel.code && (
                    <div 
                      onClick={(e) => {
                        e.stopPropagation();
                        copyCode(channel.code);
                      }}
                      className={`text-xs mt-1.5 p-1 px-1.5 border border-slate-900 inline-block cursor-pointer hover:opacity-80 ${
                        currentChannel?.id === channel.id ? 'bg-violet-800' : 'bg-violet-200'
                      }`}
                    >
                      {copiedCode === channel.code ? <Check size={12} className="inline align-middle" /> : <Copy size={12} className="inline align-middle" />} {channel.code}
                    </div>
                  )}
                </div>
              ))}
            </div>

            {/* Main Content */}
            <div className="flex-1 p-6 overflow-y-auto">
              {currentChannel && (
                <>
                  <div className="bg-white border-slate-900 p-5 mb-6" style={{border: '3px solid rgb(15,23,42)', boxShadow: '4px 4px 0 rgb(124,58,237)'}}>
                    <div className="text-lg font-bold mb-4 text-violet-800">
                      {currentChannel.isPrivate ? 'ðŸ”’' : 'ðŸ“¢'} /{currentChannel.name}/ - START NEW THREAD
                    </div>
                    <input
                      type="text"
                      placeholder="Subject (optional)"
                      value={newThreadSubject}
                      onChange={(e) => setNewThreadSubject(e.target.value)}
                      className="w-full p-3 border-2 border-slate-900 mb-3 font-mono text-sm"
                    />
                    <textarea
                      placeholder="What's on your mind, anon?"
                      value={newThreadContent}
                      onChange={(e) => setNewThreadContent(e.target.value)}
                      className="w-full p-3 border-2 border-slate-900 mb-3 font-mono text-sm resize-y"
                      style={{minHeight: '120px'}}
                    />
                    <button
                      onClick={createThread}
                      className="py-3 px-6 bg-slate-900 text-amber-100 border-slate-900 cursor-pointer font-mono font-bold text-sm hover:translate-y-0.5 transition-transform"
                      style={{border: '3px solid rgb(15,23,42)', boxShadow: '3px 3px 0 rgb(124,58,237)'}}
                    >
                      <Send size={16} className="inline mr-2 align-middle" />
                      POST THREAD
                    </button>
                  </div>

                  {/* Threads */}
                  {threads.length === 0 ? (
                    <div className="bg-violet-200 border-slate-900 p-10 text-center text-base text-violet-800" style={{border: '3px solid rgb(15,23,42)'}}>
                      No threads yet. Be the first to post!
                    </div>
                  ) : (
                    threads.map(thread => (
                      <div
                        key={thread.id}
                        className="bg-white border-slate-900 mb-5"
                        style={{border: '3px solid rgb(15,23,42)', boxShadow: '4px 4px 0 rgb(124,58,237)'}}
                      >
                        <div className="bg-violet-200 p-3 px-4 border-b-2 border-slate-900 text-sm">
                          <span className="font-bold text-violet-600">{thread.subject}</span>
                          <span className="ml-3 text-slate-500">
                            Anonymous {formatTime(thread.createdAt)}
                          </span>
                          <span className="float-right text-violet-800 font-bold">
                            {thread.replyCount} {thread.replyCount === 1 ? 'reply' : 'replies'}
                          </span>
                        </div>
                        <div className="p-4 text-sm whitespace-pre-wrap" style={{lineHeight: '1.6'}}>
                          {thread.content}
                        </div>

                        {/* Replies */}
                        {thread.replies.map(reply => (
                          <div
                            key={reply.id}
                            className="border-t-2 border-slate-900 bg-slate-50 p-3 px-4 text-sm"
                          >
                            <div className="text-xs mb-2 text-slate-500">
                              Anonymous {formatTime(reply.timestamp)}
                            </div>
                            <div className="whitespace-pre-wrap" style={{lineHeight: '1.6'}}>
                              {reply.content}
                            </div>
                          </div>
                        ))}

                        {/* Reply Box */}
                        <div className="border-t-2 border-slate-900 bg-indigo-50 p-3 px-4">
                          <textarea
                            placeholder="Reply to thread..."
                            value={replyContent[thread.id] || ''}
                            onChange={(e) => setReplyContent({ ...replyContent, [thread.id]: e.target.value })}
                            className="w-full p-2.5 border-2 border-slate-900 mb-2 font-mono text-sm resize-y"
                            style={{minHeight: '80px'}}
                          />
                          <button
                            onClick={() => addReply(thread.id)}
                            className="py-2 px-4 bg-violet-600 text-amber-100 border-2 border-slate-900 cursor-pointer font-mono font-bold text-sm hover:bg-violet-700 transition-colors"
                          >
                            <Send size={14} className="inline mr-1.5 align-middle" />
                            REPLY
                          </button>
                        </div>
                      </div>
                    ))
                  )}
                </>
              )}
            </div>
          </div>

          {/* Join Modal */}
          {showJoinModal && (
            <div className="fixed inset-0 bg-slate-900 flex items-center justify-center" style={{backgroundColor: 'rgba(15, 23, 42, 0.8)', zIndex: 1000}}>
              <div className="bg-white border-slate-900 p-6 w-[400px] max-w-[90%]" style={{border: '4px solid rgb(15,23,42)', boxShadow: '8px 8px 0 rgb(124,58,237)'}}>
                <h2 className="m-0 mb-4 text-xl text-violet-800">
                  JOIN PRIVATE CHANNEL
                </h2>
                <input
                  type="text"
                  placeholder="Enter channel code"
                  value={joinCode}
                  onChange={(e) => setJoinCode(e.target.value)}
                  className="w-full p-3 border-2 border-slate-900 mb-4 font-mono text-sm uppercase"
                />
                <div className="flex gap-3">
                  <button
                    onClick={joinChannel}
                    className="flex-1 p-3 bg-violet-600 text-amber-100 border-2 border-slate-900 cursor-pointer font-mono font-bold text-sm hover:bg-violet-700 transition-colors"
                  >
                    JOIN
                  </button>
                  <button
                    onClick={() => {
                      setShowJoinModal(false);
                      setJoinCode('');
                    }}
                    className="flex-1 p-3 bg-white text-slate-900 border-2 border-slate-900 cursor-pointer font-mono font-bold text-sm hover:bg-slate-100 transition-colors"
                  >
                    CANCEL
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<Imageboard />, document.getElementById('root'));
  </script>
</body>
</html>